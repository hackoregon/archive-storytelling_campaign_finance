<html>
<head>
  <title>Money In</title>
  <script src="lib/lodash.min.js"></script>
  <script src="lib/d3/d3.min.js"></script>
  <style>
    rect.large {
      fill: #000099;
    }
    rect.media {
      fill: #009999;
    }
    rect.business {
      fill: #009900;
    }
    rect.tick {
      fill: #ddd;
    }
  </style>
</head>
<body>


  <script>
    var large = null;
    var business = null;
    var media = null;

    var startDate = new Date('2014-1-1').getTime();
    var endDate = new Date('2014-11-15').getTime();
    var dateFilter = function(row){
      var week = new Date(row.end_date).getTime();
      return week >= startDate && week <= endDate;
    };

    d3.json('json/business.json', function(data){
      business = _.filter(data, dateFilter);
      render();
    });
    d3.json('json/large_donor.json', function(data){
      large = _.filter(data, dateFilter);
      render();
    });
    d3.json('json/paid_to_media.json', function(data){
      media = _.filter(data, dateFilter);
      render();
    });

    var render = function(){
      if (!large || !business || !media){
        return;
      }

      var width = window.document.body.getBoundingClientRect().width;
      var moneyInHeight = 100;
      var committeesHeight = 400;
      var moneyMediaHeight = 100;
      var height = moneyInHeight + committeesHeight + moneyMediaHeight;

      var svg = d3.select('body').append('svg')
        .attr("width", width)
        .attr("height", height);

      var barWidth = width / large.length;

      var yMax = d3.max(large, function(d, i) {
        return Math.max(d.s, business[i].s, media[i].s);
      });

      var moneyInScale = d3.scale.linear().range(([0,moneyInHeight]));
      moneyInScale.domain([0,yMax]);

      var group = svg.append('g').selectAll('g.week')
        .data(large)
        .enter()
        .append('g')
          .attr('class', 'week')
          .attr("transform", function(d, i) {
            return "translate(" + i * barWidth + ",0)";
          });

        // Ticks
        group.append('rect')
          .attr('class', 'tick')
          .attr('x', 0)
          .attr('y', 0)
          .attr('height', height)
          .attr('width', .5);

        // Large donors
        group.append('rect')
          .attr('class', 'large')
          .attr('x', 2)
          .attr('y', function(d){
            return moneyInHeight - moneyInScale(d.s);
          })
          .attr('height', function(d){
            return moneyInScale(d.s);
          })
          .attr('width', (barWidth / 2)-2);

        // Business
        group.append('rect')
          .attr('class', 'business')
          .attr('x', (barWidth / 2))
          .attr('y', function(d, i){
            var b = business[i]
            return moneyInHeight - moneyInScale(b.s);
          })
          .attr('height', function(d, i){
            var b = business[i]
            return moneyInScale(b.s);
          })
          .attr('width', (barWidth / 2)-2);


        // Media
        group.append('rect')
          .attr('class', 'media')
          .attr('x', 1)
          .attr('y', function(d, i){
            return moneyInHeight +  committeesHeight;
          })
          .attr('height', function(d, i){
            var m = media[i]
            return moneyInScale(m.s);
          })
          .attr('width', barWidth - 2);

    };

  </script>
</body>
</html>
